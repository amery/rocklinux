# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/fake/mythtv/mythtv.conf
# ROCK Linux is Copyright (C) 1998 - 2004 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---


if [ -z "$ROCKCFG_PKG_MYTHTV_PREFIX" ] ; then
	prefix=opt/mythtv
else
	prefix=$ROCKCFG_PKG_MYTHTV_PREFIX
fi

mythtv_prepatch() {
	# apply the dvb patches to enable channel scanning, etc.
	bzcat $archdir/dvb_patch_v2.1-fake.diff.bz2 | patch -p0
	# .. and extract the embedded bzip2 into the mythtv dir.
	tar --use-compress-program=bzip2 -xf $archdir/dvb_patch_v2.1_files.tar.bz2 
}

mythtv_premake() {

	sed -i -e "s,PREFIX = /usr/local\$,PREFIX = $root/$prefix," settings.pro

	# enable dvb support if we have some includes to feed to mythtv
	for dvbdir in $root/usr/include $root/usr/src/linux*/include ; do
		if [ -f $dvbdir/linux/dvb/frontend.h ] ; then	
			echo "CONFIG += using_dvb" >> settings.pro
			echo "DEFINES += USING_DVB" >> settings.pro
			echo "INCLUDEPATH += $dvbdir" >> settings.pro
			break
		fi
	done

	if pkginstalled alsa ; then
		echo "CONFIG += using_alsa" >> settings.pro
		echo "ALSA_LIBS = -lasound" >> settings.pro
	fi 

	if pkginstalled lirc ; then
		echo "CONFIG += using_lirc" >> settings.pro
		echo "LIRC_LIBS = -llirc_client" >> settings.pro
	fi

	# nvidia's XvMC is the only supported. we will never see this in a build-target,
	# but maybe in an emerge-package of someone who read this - like you and me ;)
	if [ ! -z "`ls $root/usr/X11R6/lib/libXvMCNVIDIA.so* 2>/dev/null`" ] ; then
		echo "CONFIG += using_xvmc" >> settings.pro
		echo "DEFINES += USING_XVMC" >> settings.pro
		echo "EXTRA_LIBS += -lXvMCNVIDIA -lXvMC" >> settings.pro
	fi

	qmake mythtv.pro
}

mythtv_postmake() {
	cp setup/setup $root/$prefix/bin/mythsetup
	cp -r configfiles $docdir/examples
}

hook_add prepatch 1 mythtv_prepatch
hook_add premake 1 mythtv_premake
hook_add postmake 5 mythtv_postmake

